<!DOCTYPE html>
<html>
<head>
  <title>Activities to Actuals Calculator (Impact Total = LOP Target)</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; vertical-align: top; }
    input[type=range] { width: 120px; }
    .slider-container { display: flex; flex-direction: column; align-items: center; }
    .buttons { margin-bottom: 15px; }
    button { margin-right: 10px; padding: 6px 12px; }

    /* Group coloring */
    .outcome1 { background-color: #d9fdd3; } /* light green */
    .outcome2 { background-color: #e8ddff; } /* light purple */
  </style>
</head>
<body>
  <h2>Activities to Actuals Calculator (Impact Total = LOP Target)</h2>

  <div class="buttons">
    <button onclick="presetOC2_20()">20% OC2 assumptions</button>
    <button onclick="preset2025Q2()">2025Q2 impact results</button>
    <button onclick="presetB1bContribution()">OC2 Contributes to B1b = 15000</button>
    <button onclick="presetOC2Activities(75000)">OC2 reaches 75000</button>
    <button onclick="presetOC2Activities(150000)">OC2 reaches 150000</button>
    <button onclick="resetAll()">Reset All</button>
  </div>

  <table id="calcTable">
    <thead>
      <tr>
        <th rowspan="2">Indicator</th>
        <th colspan="3" class="outcome1">Outcome 1</th>
        <th colspan="3" class="outcome2">Outcome 2</th>
        <th rowspan="2">Mangwana LOP Target</th>
      </tr>
      <tr>
        <th class="outcome1">Outcome 1 Activity Target Reach</th>
        <th class="outcome1">Outcome 1 Impact</th>
        <th class="outcome1">Outcome 1 Contribution to LOP</th>
        <th class="outcome2">Outcome 2 Activity Reach</th>
        <th class="outcome2">Outcome 2 Impact %</th>
        <th class="outcome2">Outcome 2 Contribution to LOP</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const data = [
      { indicator: "A1 # of people with a more diverse and adequate diet", target: 227770, percent: 0.51, origPercent: 0.51, lop: 227766, estImpact: 0.2, activities: 558016, outcome1Target: 227770 },
      { indicator: "A2 # of people whose nutritional situation became more resilient to shocks", target: 227770, percent: 0.624, origPercent: 0.624, lop: 68329, estImpact: 0.2, activities: 0, outcome1Target: 227770 },
      { indicator: "B1a # of SSFP who progressively realized a living income", target: 45554, percent: 0.161, origPercent: 0.161, lop: 45554, estImpact: 0.2, activities: 191099, outcome1Target: 45554 },
      { indicator: "B1b # of SSFP who progressively decrease the yield gap.", target: 45554, percent: 0.173, origPercent: 0.173, lop: 60739, estImpact: 0.2, activities: 264291, outcome1Target: 45554 },
      { indicator: "B1c # of female SSFP who progressively become more empowered", target: 15184, percent: 0.721, origPercent: 0.721, lop: 15184, estImpact: 0.2, activities: 0, outcome1Target: 15184 },
      { indicator: "B2 # of SSFP whose livelihoods became more resilient to shocks", target: 45554, percent: 0.492, origPercent: 0.492, lop: 45554, estImpact: 0.2, activities: 0, outcome1Target: 45554 },
      { indicator: "C1 # ha under at least 2 conservation practices", target: 27332, percent: 0.476, origPercent: 0.476, lop: 27332, estImpact: 0.2, activities: 0, outcome1Target: 27332 },
      { indicator: "C2 # of hectares of farmland that agro-ecologically become more resilient", target: 81995, percent: 0.470, origPercent: 0.470, lop: 81995, estImpact: 0.2, activities: 238692, outcome1Target: 81995 }
    ];

    function clamp(val) {
      return Math.max(0, val); // no negatives
    }

    function recalcRow(i, changedField) {
      const row = data[i];
      const lopTarget = row.lop;

      if (changedField === "percent") {
        const contribution = Math.floor(clamp(row.target * row.percent));
        const requiredContribution = clamp(lopTarget - contribution);
        row.activities = row.estImpact > 0 ? clamp(requiredContribution / row.estImpact) : 0;
      } 
      else if (changedField === "estImpact") {
        // When changing Outcome 2 Impact %, adjust Activities instead
        row.estImpact = clamp(row.estImpact);
        const contribution = Math.floor(clamp(row.target * row.percent));
        const requiredContribution = clamp(lopTarget - contribution);
        row.activities = row.estImpact > 0 ? clamp(requiredContribution / row.estImpact) : 0;
      }
      else if (changedField === "activities") {
        const requiredContribution = clamp(row.activities * row.estImpact);
        const contribution = clamp(lopTarget - requiredContribution);
        row.percent = clamp(contribution / row.target);
      }

      const contribution = Math.floor(clamp(row.target * row.percent));
      const requiredContribution = clamp(row.lop - contribution);

      // clamp values
      row.percent = clamp(row.percent);
      row.estImpact = clamp(row.estImpact);
      row.activities = clamp(row.activities);

      // Update DOM
      document.getElementById(`contribution-${i}`).textContent = contribution;
      document.getElementById(`required-${i}`).textContent = requiredContribution.toFixed(0);
      document.getElementById(`lop-${i}`).textContent = row.lop;
      document.getElementById(`percent-${i}`).value = row.percent;
      document.getElementById(`percentLabel-${i}`).textContent = (row.percent * 100).toFixed(1) + "%";
      document.getElementById(`estImpact-${i}`).value = row.estImpact;
      document.getElementById(`estImpactLabel-${i}`).textContent = (row.estImpact * 100).toFixed(1) + "%";
      document.getElementById(`activities-${i}`).value = row.activities;
      document.getElementById(`activitiesLabel-${i}`).textContent = Math.floor(row.activities);
    }

    function buildTable() {
      const tbody = document.querySelector("#calcTable tbody");
      tbody.innerHTML = ""; 
      data.forEach((row, i) => {
        const contribution = Math.floor(clamp(row.target * row.percent));
        const requiredContribution = clamp(row.lop - contribution);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.indicator}</td>
          <td class="outcome1">${row.outcome1Target}</td>
          <td class="outcome1">
            <div class="slider-container">
              <input type="range" id="percent-${i}" min="0" max="1" step="0.01" value="${row.percent}"
                     oninput="data[${i}].percent=parseFloat(this.value);recalcRow(${i}, 'percent')">
              <span id="percentLabel-${i}">${(row.percent * 100).toFixed(1)}%</span>
            </div>
          </td>
          <td class="outcome1" id="contribution-${i}">${contribution}</td>
          <td class="outcome2">
            <div class="slider-container">
              <input type="range" id="activities-${i}" min="0" max="${row.target * 20}" step="1" value="${row.activities}"
                     oninput="data[${i}].activities=parseFloat(this.value);recalcRow(${i}, 'activities')">
              <span id="activitiesLabel-${i}">${Math.floor(row.activities)}</span>
            </div>
          </td>
          <td class="outcome2">
            <div class="slider-container">
              <input type="range" id="estImpact-${i}" min="0" max="1" step="0.01" value="${row.estImpact}"
                     oninput="data[${i}].estImpact=parseFloat(this.value);recalcRow(${i}, 'estImpact')">
              <span id="estImpactLabel-${i}">${(row.estImpact * 100).toFixed(1)}%</span>
            </div>
          </td>
          <td class="outcome2" id="required-${i}">${requiredContribution.toFixed(0)}</td>
          <td id="lop-${i}">${row.lop}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // === Presets ===
    function presetOC2_20() {
      data.forEach((row, i) => {
        row.estImpact = 0.2;
        recalcRow(i, "estImpact");
      });
    }

    function preset2025Q2() {
      data.forEach((row, i) => {
        row.percent = row.origPercent;
        recalcRow(i, "percent");
      });
    }

    function presetB1bContribution() {
      const i = data.findIndex(r => r.indicator.includes("B1b"));
      if (i >= 0) {
        const row = data[i];
        const requiredContribution = 15000;
        const contribution = clamp(row.lop - requiredContribution);
        row.percent = clamp(contribution / row.target);
        row.activities = row.estImpact > 0 ? clamp(requiredContribution / row.estImpact) : 0;
        recalcRow(i, "activities");
      }
    }

    function presetOC2Activities(value) {
      data.forEach((row, i) => {
        row.activities = clamp(value);
        recalcRow(i, "activities");
      });
    }

    function resetAll() {
      data.forEach((row, i) => {
        row.percent = row.origPercent;
        row.estImpact = 0.2;
        row.activities = clamp(row.activities);
        recalcRow(i, "percent");
      });
    }

    buildTable();
  </script>
</body>
</html>
